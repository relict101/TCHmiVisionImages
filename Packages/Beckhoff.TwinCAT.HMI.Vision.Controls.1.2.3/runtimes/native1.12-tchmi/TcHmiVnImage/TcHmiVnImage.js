var TcHmi,__awaiter=this&&this.__awaiter||function(e,t,i,s){return new(i||(i=Promise))((function(o,a){function r(e){try{n(s.next(e))}catch(e){a(e)}}function _(e){try{n(s.throw(e))}catch(e){a(e)}}function n(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,_)}n((s=s.apply(e,t||[])).next())}))};!function(e){let t;!function(t){let i;!function(t){let i;!function(t){class i extends t.TcHmiVnControl{constructor(e,s,o){super(e,s,o),this.__$props=new i.Properties,this.__$controls=new i.SubControls,this.__viewer={frame:{width:0,height:0,x:0,y:0},image:{dataUri:"",lastLoadedUri:"",visible:!1,screenSize:[0,0],scaleFactor:1,autoScaling:!1,fitActive:!1,fitDone:!1,canvas:null,historyQueue:[]}},this.__gestures={pointer:{assumedPressState:!1,mouseDownTime:0,lastKnownPosition:null},pinch:{assumedPinch:!1,activeTouchIds:[0,0],startTouchCenter:t.Vector.zeros(2),startTouchDistance:0,startImageOffset:t.Vector.zeros(2),startImageScale:100,startImageSpot:t.Vector.zeros(2),startTime:0},drag:{inProgress:!1,lastPosition:t.Vector.zeros(2)}},this.__diagnostics={dataReceivalList:[],imageReceivalList:[],imagesLost:0,sourceWasSetEvent:{Time:0,Id:0,Last:0}},this.__destroyScalingSelectionEventListener=null,this.__destroyFreezeEventListener=null,this.__destroyDownloadEventListener=null,this.__destroyShapeEventListener=null,this.__destroyShapeSymbolListener=null,this.__$events.register(["PixelInfo","ShapeConfirmed","ImageReceived"])}__attach(){this.__registerDomElements(),this.__registerGestureEventListeners(),super.__attach(),this.__updateAppearance(),this.__updateThumbnailPosition(),this.__updateOverlayElements(),this.__updateViewer(),this.__processAlt()}__registerGestureEventListeners(){this.__$dom.Surface.bind("mousedown",(e=>this.__handlePointerStart(e))),this.__$dom.Surface.bind("mousemove",(e=>this.__handlePointerMove(e))),this.__$dom.Surface.bind("mouseup",(e=>this.__handlePointerEnd(e))),this.__$dom.Surface.bind("mouseleave",(e=>this.__handlePointerCancel(e))),this.__$dom.Surface.bind("wheel",(e=>this.__handleWheel(e))),this.__$dom.Surface.bind("touchstart",(e=>this.__handleTouchStart(e))),this.__$dom.Surface.bind("touchmove",(e=>this.__handleTouchMove(e))),this.__$dom.Surface.bind("touchend",(e=>this.__handleTouchEnd(e))),this.__$dom.Surface.bind("touchcancel",(e=>this.__handleTouchCancel(e)))}__onDragStart(e){this.__gestures.drag.inProgress=!0,this.__gestures.drag.lastPosition=e}__onDragMove(e){const t=e.x-this.__gestures.drag.lastPosition.x,i=e.y-this.__gestures.drag.lastPosition.y,s=this.__constrainOffset([this.__$props.Offset[0]+t,this.__$props.Offset[1]+i],this.__$props.Scale);this.__gestures.drag.lastPosition=e,this.__setOffsetInternal(s)}__onDragEnd(){this.__gestures.drag.inProgress=!1}__handlePointerStart(e){if(e.preventDefault(),!this.__isValidPointer(e))return;if(this.__gestures.pointer.assumedPressState=!0,this.__gestures.pointer.mouseDownTime=(new Date).getTime(),!this.__$props.Draggable)return;const t=this.__adjustedEventPosition(e);this.__onDragStart(t)}__handlePointerMove(e){if(e.preventDefault(),!this.__viewer.image.visible)return;const t=this.__adjustedEventPosition(e);this.__gestures.pointer.lastKnownPosition=t,this.__gestures.drag.inProgress||this.__$props.PixelInfoUpdate===i.Schema.PixelInfoUpdate.AtCursor&&this.__computePixelInfo(),this.__isValidPointer(e)&&(this.__$props.Draggable&&this.__gestures.drag.inProgress?this.__onDragMove(t):this.__handlePointerEnd(e))}__handlePointerEnd(e){e.preventDefault(),this.__$props.PixelInfoUpdate===i.Schema.PixelInfoUpdate.AtClick&&this.__gestures.pointer.assumedPressState&&(new Date).getTime()-this.__gestures.pointer.mouseDownTime<200&&this.__computePixelInfo(),this.__gestures.pointer.assumedPressState=!1,this.__onDragEnd()}__handlePointerCancel(e){e.preventDefault(),this.__gestures.pointer.lastKnownPosition=null,this.__$props.PixelInfoUpdate===i.Schema.PixelInfoUpdate.AtCursor&&this.__clearPixelInfo()}__handleWheel(e){if(e.preventDefault(),!this.__$props.Scalable)return;if(!this.__viewer.image.visible)return;let i=-1*(e.originalEvent?e.originalEvent.deltaY:0)*.05*this.__$props.Scale/100,s=this.__$props.Scale+i;if(s=i<0?Math.max(s,this.__$props.ScaleMin):Math.min(s,this.__$props.ScaleMax),i=s-this.__$props.Scale,0!==i){const o=this.__adjustedEventPosition(e),a=t.Vector.fromArray(this.__$props.Offset).minus(o).times(1+i/this.__$props.Scale),r=o.plus(a),_=this.__constrainOffset(r.toArray(),s);this.__setOffsetInternal(_),this.__setScaleInternal(s)}}__handleTouchStart(e){e.preventDefault(),1===e.touches.length&&this.__handlePointerStart(e),2===e.touches.length&&this.__handlePinchStart(e)}__handleTouchMove(e){e.preventDefault(),this.__viewer.image.visible&&(1===e.touches.length&&(this.__gestures.pinch.assumedPinch?(this.__handlePinchCancel(),this.__handlePointerStart(e)):this.__handlePointerMove(e)),2===e.touches.length&&this.__handlePinchMove(e))}__handleTouchEnd(e){e.preventDefault(),this.__gestures.pointer.assumedPressState&&this.__handlePointerEnd(e),this.__gestures.pinch.assumedPinch&&this.__handlePinchEnd(e)}__handleTouchCancel(e){e.preventDefault(),this.__gestures.pointer.assumedPressState&&this.__handlePointerCancel(e),this.__gestures.pinch.assumedPinch&&this.__handlePinchCancel(e)}__handlePinchStart(e){if(2!==e.touches.length)return;if(!this.__$props.Draggable)return;if(!this.__$props.Scalable)return;this.__gestures.pinch.assumedPinch=!0,this.__gestures.pinch.activeTouchIds[0]=e.touches[0].identifier,this.__gestures.pinch.activeTouchIds[1]=e.touches[1].identifier;const i=t.Position.fromTouch(e.touches[0]),s=t.Position.fromTouch(e.touches[1]);this.__gestures.pinch.startTime=t.timestamp(),this.__gestures.pinch.startTouchDistance=i.distanceTo(s),this.__gestures.pinch.startTouchCenter=t.Position.fromCenter(i,s),this.__gestures.pinch.startImageOffset=t.Vector.fromArray(this.__$props.Offset),e.target!==this.__$dom.Surface[0]&&(this.__gestures.pinch.startTouchCenter=this.__gestures.pinch.startTouchCenter.plus(this.__gestures.pinch.startImageOffset)),this.__gestures.pinch.startImageScale=this.__$props.Scale,this.__gestures.pinch.startImageSpot=this.__gestures.pinch.startTouchCenter.minus(this.__gestures.pinch.startImageOffset)}__handlePinchMove(e){if(2!==e.touches.length)return;if(!this.__viewer.image.visible)return;if(!this.__gestures.pinch.assumedPinch)return;if(!this.__$props.Scalable)return void this.__handlePinchCancel(null);this.__gestures.pinch.activeTouchIds[0]!==e.touches[0].identifier&&this.__handlePinchCancel(),this.__gestures.pinch.activeTouchIds[1]!==e.touches[1].identifier&&this.__handlePinchCancel();const i=t.Position.fromTouch(e.touches[0]),s=t.Position.fromTouch(e.touches[1]),o=i.distanceTo(s);let a=t.Position.fromCenter(i,s);const r=t.Vector.fromArray(this.__$props.Offset);e.target!==this.__$dom.Surface[0]&&(a=a.plus(r));const _=o/this.__gestures.pinch.startTouchDistance;let n=this.__gestures.pinch.startImageScale*_;n=Math.max(n,this.__$props.ScaleMin),n=Math.min(n,this.__$props.ScaleMax),this.__setScaleInternal(n);const h=this.__gestures.pinch.startImageSpot.times(_),l=this.__constrainOffset(a.minus(h).toArray(),n);this.__setOffsetInternal(l)}__handlePinchEnd(e){this.__gestures.pinch.assumedPinch=!1}__handlePinchCancel(e=null){this.__gestures.pinch.assumedPinch=!1}__adjustedEventPosition(e){const i=t.Position.fromEvent(e);if(e.target!==this.__$dom.Surface[0]){const e=t.Vector.fromArray(this.__$props.Offset),s=t.Vector.fromArray(this.__viewer.image.screenSize);return i.plus(e).minus(s)}return i}__computePixelInfo(){if(!this.__gestures.pointer.lastKnownPosition)return void this.__clearPixelInfo();const e=this.__gestures.pointer.lastKnownPosition,i=t.Vector.fromArray(this.__$props.Offset);if(!t.between(e.x,i.x,i.x+this.__viewer.image.screenSize[0])||!t.between(e.y,i.y,i.y+this.__viewer.image.screenSize[1]))return void this.__clearPixelInfo();const s=e.minus(i).times(100/this.__$props.Scale/this.__viewer.image.scaleFactor).round();if(this.__setPixelPositionInternal(s.toArray()),this.__viewer.image.canvas){const e=this.__viewer.image.canvas.getImageData(s.x,s.y,1,1).data.slice(0,4);this.__setPixelColorInternal(Array.from(e))}else this.__setPixelColorInternal([0,0,0,0]);this.__updatePixelColorInfo(),this.__$events.PixelInfo.raise()}__loadImage(e){return new Promise(((t,i)=>{const s=new Image;s.src=e,s.onload=()=>t(s),window.setTimeout((()=>i("Timeout (5 seconds). Image could not be loaded.")),1e3)}))}__isValidPointer(e){return!!e.type.includes("touch")||!!e.type.includes("mouse")&&(e.buttons||0)%2==1}__clearPixelInfo(){this.__isAttached&&(this.__setPixelColorInternal([0,0,0,0]),this.__setPixelPositionInternal([0,0]),this.__$dom["Infobar-PixelPosition"].html(""),this.__$dom["Infobar-PixelColor"].html(""))}__updateViewer(){return __awaiter(this,void 0,void 0,(function*(){this.__isAttached&&(this.__updateImageDataUri(),yield this.__updateImageUI(),this.__updateThumbnail())}))}__updateImageDataUri(){this.__viewer.image.visible=!1,this.__viewer.image.fitDone=!1,this.__$props.Image&&(this.__viewer.image.visible=!0,this.__$props.ImageFreeze&&""!==this.__viewer.image.dataUri||(this.__$props.QueueIndex>0&&this.__$props.QueueIndex<this.__viewer.image.historyQueue.length?this.__viewer.image.dataUri=this.__viewer.image.historyQueue[this.__$props.QueueIndex]:this.__viewer.image.dataUri=this.__$props.Image))}__updateImageUI(){return __awaiter(this,void 0,void 0,(function*(){if(this.__isAttached)if(this.__viewer.image.visible){const e=this.__element[0].clientWidth,t=this.__element[0].clientHeight;if(yield this.__updateImageData(this.__viewer.image.dataUri||""),this.__viewer.image.fitActive&&!this.__viewer.image.fitDone)return void this.__fitImageToControl(!0);let s,o;this.__diagnostics.sourceWasSetEvent.Time=(new Date).getTime(),++this.__diagnostics.sourceWasSetEvent.Id,this.__$dom.Image.attr("src",this.__viewer.image.dataUri),this.__$props.OverlayVisible?(this.__$dom.OverlaySVG.css("display","block"),this.__$props.OverlayImage?(this.__$dom.OverlayImage.css("display","block"),this.__$props.OverlayImage?this.__$dom.OverlayImage.attr("src",this.__$props.OverlayImage):this.__$dom.OverlayImage.attr("src","")):this.__$dom.OverlayImage.css("display","none")):(this.__$dom.OverlaySVG.css("display","none"),this.__$dom.OverlayImage.css("display","none")),this.__$dom.Viewer.css("left",this.__$props.Offset[0]+"px"),this.__$dom.Viewer.css("top",this.__$props.Offset[1]+"px");const a=this.__$props.Scale/100;if(this.__viewer.image.autoScaling){if(this.__$props.ScaleReference===i.Schema.ScaleReference.ControlWidth)this.__viewer.image.scaleFactor=this.__viewer.frame.width/this.__$props.ImageSize[0];else if(this.__$props.ScaleReference===i.Schema.ScaleReference.ControlHeight)this.__viewer.image.scaleFactor=this.__viewer.frame.height/this.__$props.ImageSize[1];else if(this.__$props.ScaleReference===i.Schema.ScaleReference.ControlSize){const i=e/t,s=this.__$props.ImageSize[0]/this.__$props.ImageSize[1];this.__viewer.image.scaleFactor=s>=i?this.__viewer.frame.width/this.__$props.ImageSize[0]:this.__viewer.frame.height/this.__$props.ImageSize[1]}s=Math.floor(a*this.__$props.ImageSize[0]*this.__viewer.image.scaleFactor),o=Math.floor(a*this.__$props.ImageSize[1]*this.__viewer.image.scaleFactor)}else this.__viewer.image.scaleFactor=1,s=Math.floor(a*this.__$props.ImageSize[0]),o=Math.floor(a*this.__$props.ImageSize[1]);this.__viewer.image.screenSize=[s,o],this.__setImageDisplaySizeInternal([s,o]),this.__$dom.Image.width(s),this.__$dom.Image.height(o),this.__$dom.Image.attr("width",s),this.__$dom.Image.attr("height",o),this.__$dom.OverlayImage.width(s),this.__$dom.OverlayImage.height(o),this.__$dom.OverlayImage.attr("width",s),this.__$dom.OverlayImage.attr("height",o),this.__$dom.OverlaySVG.width(s),this.__$dom.OverlaySVG.height(o),null!=this.__$controls.Shape&&(this.__$controls.Shape.setDataOffset(this.__viewer.image.screenSize),this.__$controls.Shape.setDataScale(this.__$props.Scale/100*this.__viewer.image.scaleFactor),this.__$controls.Shape.setWidth(3*s),this.__$controls.Shape.setHeight(3*o),this.__$controls.Shape.setLeft(this.__$props.Offset[0]-s),this.__$controls.Shape.setTop(this.__$props.Offset[1]-o)),this.__$dom.Placeholder.css("display","none"),this.__$dom.Image.css("display","block"),this.__$props.PixelInfoUpdate===i.Schema.PixelInfoUpdate.AtCursor&&this.__computePixelInfo()}else this.__$dom.Image.css("display","none"),this.__$dom.Placeholder.css("display","flex"),this.__$dom.Placeholder.children().html(this.__$props.Alt),this.__$dom.OverlayImage.css("display","none"),this.__$dom.OverlaySVG.css("display","none")}))}__updateImageData(e){return this.__viewer.image.lastLoadedUri===e?Promise.resolve(this.__$props.ImageSize):this.__loadImage(e).then((t=>{this.__viewer.image.lastLoadedUri=e;const i=document.createElement("canvas");i.width=t.width,i.height=t.height;const s=i.getContext("2d");return null==s||s.drawImage(t,0,0,t.width,t.height),this.__viewer.image.canvas=s,this.__setImageSizeInternal([t.width,t.height]),[t.width,t.height]}))}__updateAppearance(){this.__updateLayout(),this.__updateThumbnail()}__updateLayout(){if(!this.__isAttached)return;const e=this.__element[0].clientWidth,t=this.__element[0].clientHeight;this.__viewer.frame.width=e,this.__viewer.frame.x=0,this.__updateToolbar(),this.__updateInfobar();const i=this.__$props.ToolbarVisible?this.__$props.ToolbarHeight:0,s=t-i-(this.__$props.InfobarVisible?this.__$props.InfobarHeight:0);this.__$dom.Frame.height(s+"px"),this.__$dom.Frame.css("top",i),this.__viewer.frame.height=s,this.__viewer.frame.y=i}__updateThumbnail(){if(this.__isAttached)if(this.__$props.ThumbnailVisible){const e=this.__$props.ImageSize,t=this.__$props.ThumbnailSize;let i,s,o,a,r,_;if(0===e[0]||0===e[1])_=t,r=t,i=t,s=t,o=0,a=0;else{const n=this.__$props.Offset[0],h=this.__$props.Offset[1];r=t,_=Math.floor(e[1]/e[0]*r);const l=Math.abs(Math.min(0,h)),c=Math.abs(Math.min(0,n)),p=Math.max(0,n+this.__viewer.image.screenSize[0]-this.__viewer.frame.width),m=Math.max(0,h+this.__viewer.image.screenSize[1]-this.__viewer.frame.height),g=l/this.__viewer.image.screenSize[1],d=c/this.__viewer.image.screenSize[0],u=p/this.__viewer.image.screenSize[0],S=m/this.__viewer.image.screenSize[1];i=(1-S-g)*_,s=(1-d-u)*r,o=Math.min(S*_,_),a=Math.min(u*r,r)}this.__$dom.Thumbnail.css("display","block"),this.__$dom.ThumbnailMarker.css("display","block"),this.__$dom.Thumbnail.width(r),this.__$dom.Thumbnail.height(_),this.__$dom.ThumbnailMarker.css("width",s),this.__$dom.ThumbnailMarker.css("height",i),this.__$dom.ThumbnailMarker.css("bottom",o+"px"),this.__$dom.ThumbnailMarker.css("right",a+"px")}else this.__$dom.Thumbnail.css("display","none"),this.__$dom.ThumbnailMarker.css("display","none")}__updateThumbnailPosition(){if(this.__isAttached&&this.__$props.ThumbnailVisible)switch(this.__$props.ThumbnailPosition){case i.Schema.ThumbnailPosition.TopLeft:this.__$dom.Thumbnail.css("top",0),this.__$dom.Thumbnail.css("left",0),this.__$dom.Thumbnail.css("right",""),this.__$dom.Thumbnail.css("bottom","");break;case i.Schema.ThumbnailPosition.TopRight:this.__$dom.Thumbnail.css("top",0),this.__$dom.Thumbnail.css("left",""),this.__$dom.Thumbnail.css("right",0),this.__$dom.Thumbnail.css("bottom","");break;case i.Schema.ThumbnailPosition.BottomLeft:this.__$dom.Thumbnail.css("top",""),this.__$dom.Thumbnail.css("left",0),this.__$dom.Thumbnail.css("right",""),this.__$dom.Thumbnail.css("bottom",0);break;case i.Schema.ThumbnailPosition.BottomRight:this.__$dom.Thumbnail.css("top",""),this.__$dom.Thumbnail.css("left",""),this.__$dom.Thumbnail.css("right",0),this.__$dom.Thumbnail.css("bottom",0)}}__updateToolbar(){if(!this.__isAttached)return;const e=this.__$props.ToolbarHeight;if(this.__$props.ToolbarItems.imageSelectionVisible&&this.__$props.ImageList.length>0){if(null==this.__$controls.ImageSelection&&this.__createImageSelection(),null!=this.__$controls.ImageSelection){let t=0;this.__$props.ToolbarItems.scaleSelectionVisible&&(t+=this.__$props.ScaleSelectionWidth),this.__$props.ToolbarItems.shapeButtonVisible&&(t+=e),this.__$props.ToolbarItems.freezeButtonVisible&&(t+=e),this.__$props.ToolbarItems.downloadButtonVisible&&(t+=e),this.__$controls.ImageSelection.setWidth(this.__$props.ImageSelectionWidth),this.__$controls.ImageSelection.setHeight(e),this.__$controls.ImageSelection.setRight(t)}}else null!=this.__$controls.ImageSelection&&this.__destroyImageSelection();if(this.__$props.ToolbarItems.scaleSelectionVisible){if(null==this.__$controls.ScaleSelection&&this.__createScaleSelection(),null!=this.__$controls.ScaleSelection){let t=0;this.__$props.ToolbarItems.shapeButtonVisible&&(t+=e),this.__$props.ToolbarItems.downloadButtonVisible&&(t+=e),this.__$props.ToolbarItems.freezeButtonVisible&&(t+=e),this.__$controls.ScaleSelection.setWidth(this.__$props.ScaleSelectionWidth),this.__$controls.ScaleSelection.setHeight(e),this.__$controls.ScaleSelection.setRight(t),this.__$props.ScaleSelectionEditable?this.__$dom["ScaleSelection-TouchGuard"].css("display","none"):(this.__$dom["ScaleSelection-TouchGuard"].css("display","block"),this.__$dom["ScaleSelection-TouchGuard"].css("width",this.__$props.ScaleSelectionWidth-26),this.__$dom["ScaleSelection-TouchGuard"].css("height",e),this.__$dom["ScaleSelection-TouchGuard"].css("right",t+26))}}else null!=this.__$controls.ScaleSelection&&this.__destroyScaleSelection();if(this.__$props.ToolbarItems.shapeButtonVisible){if(null==this.__$controls.ShapeButton&&this.__createShapeButton(),null!=this.__$controls.ShapeButton){let t=0;this.__$props.ToolbarItems.downloadButtonVisible&&(t+=e),this.__$props.ToolbarItems.freezeButtonVisible&&(t+=e),this.__$controls.ShapeButton.setWidth(e),this.__$controls.ShapeButton.setHeight(e),this.__$controls.ShapeButton.setRight(t),this.__updateShapeButtonIcon()}}else null!=this.__$controls.ShapeButton&&this.__destroyShapeButton();if(this.__$props.ToolbarItems.freezeButtonVisible){if(null==this.__$controls.FreezeButton&&this.__createFreezeButton(),null!=this.__$controls.FreezeButton){let t=0;this.__$props.ToolbarItems.downloadButtonVisible&&(t+=e),this.__$controls.FreezeButton.setWidth(e),this.__$controls.FreezeButton.setHeight(e),this.__$controls.FreezeButton.setRight(t),this.__updateFreezeButtonIcon()}}else null!=this.__$controls.FreezeButton&&this.__destroyFreezeButton();this.__$props.ToolbarItems.downloadButtonVisible?(null==this.__$controls.DownloadButton&&this.__createDownloadButton(),null!=this.__$controls.DownloadButton&&(this.__$controls.DownloadButton.setWidth(e),this.__$controls.DownloadButton.setHeight(e))):null!=this.__$controls.DownloadButton&&this.__destroyDownloadButton(),this.__$props.ToolbarVisible?(this.__$dom.Toolbar.css("display","block"),this.__$dom.Toolbar.css("height",`${this.__$props.ToolbarHeight}px`),this.__$dom.Toolbar.css("background-color",this.__$props.BarColor.color)):this.__$dom.Toolbar.css("display","none")}__updateInfobar(){this.__isAttached&&(this.__$props.InfobarItems.shapeValueVisible?(this.__$dom["Infobar-ShapeValue"].css("display","block"),this.__$dom["Infobar-ShapeValueIcon"].css("display","block")):(this.__$dom["Infobar-ShapeValue"].css("display","none"),this.__$dom["Infobar-ShapeValueIcon"].css("display","none")),this.__$props.InfobarItems.pixelColorVisible?(this.__$dom["Infobar-PixelColor"].css("display","block"),this.__$dom["Infobar-PixelColorIcon"].css("display","block")):(this.__$dom["Infobar-PixelColor"].css("display","none"),this.__$dom["Infobar-PixelColorIcon"].css("display","none")),this.__$props.InfobarItems.pixelPositionVisible?(this.__$dom["Infobar-PixelPosition"].css("display","block"),this.__$dom["Infobar-PixelPositionIcon"].css("display","block")):(this.__$dom["Infobar-PixelPosition"].css("display","none"),this.__$dom["Infobar-PixelPositionIcon"].css("display","none")),this.__$props.InfobarItems.imageSizeVisible?(this.__$dom["Infobar-ImageSize"].css("display","block"),this.__$dom["Infobar-ImageSizeIcon"].css("display","block")):(this.__$dom["Infobar-ImageSize"].css("display","none"),this.__$dom["Infobar-ImageSizeIcon"].css("display","none")),this.__$props.InfobarVisible?(this.__$dom.Infobar.css("display","flex"),this.__$dom.Infobar.css("height",`${this.__$props.InfobarHeight}px`),this.__$dom.Infobar.css("background-color",this.__$props.BarColor.color)):this.__$dom.Infobar.css("display","none"))}__updateShapeInfo(t){if(this.__isAttached&&null!=this.__$props.ShapeValueFormat&&null!=this.__$controls.Shape){const i=this.__$controls.Shape.getShapeData();try{const s=new e.Function(this.__$props.ShapeValueFormat).execute([i,t]);this.__$dom["Infobar-ShapeValue"].html(s)}catch(e){this.__$log.warning("Could not execute InfobarShapeFormat function.",e)}this.__updateShapeIsInImageArea()}else this.__$dom["Infobar-ShapeValue"].html("");this.__$events.ShapeConfirmed.raise()}__createShapeButton(){this.__$controls.ShapeButton=this.__$createSubControl("TcHmiToggleButton","ShapeButton",{"data-tchmi-width":this.__$props.ToolbarHeight,"data-tchmi-height":this.__$props.ToolbarHeight,"data-tchmi-left":null,"data-tchmi-right":0,"data-tchmi-text":"","data-tchmi-icon-width":24,"data-tchmi-icon-height":24},this.__$dom.Toolbar),null!=this.__$controls.ShapeButton?e.Binding.createEx2(`%ctrl%${this.getId()}::ShapeSelectionActive%/ctrl%`,"StateSymbol",this.__$controls.ShapeButton):this.__$log.warning("ShapeButton sub-control could not be created.")}__updateShapeButtonIcon(){if(null==this.__$controls.ShapeButton)return;let t=e.Environment.getControlBasePathEx(this)||"";this.__$props.ShapeSelectionActive?t+="/Images/shape_mouse.svg":t+="/Images/shapes.svg",this.__$controls.ShapeButton.setIcon(t)}__destroyShapeButton(){null!=this.__$controls.ShapeButton&&(e.Binding.removeEx2(null,"StateSymbol",this.__$controls.ShapeButton),this.__$controls.ShapeButton.destroy(),this.__$controls.ShapeButton=null)}__createFreezeButton(){this.__$controls.FreezeButton=this.__$createSubControl("TcHmiToggleButton","FreezeButton",{"data-tchmi-width":this.__$props.ToolbarHeight,"data-tchmi-height":this.__$props.ToolbarHeight,"data-tchmi-left":null,"data-tchmi-right":0,"data-tchmi-text":"","data-tchmi-icon-width":24,"data-tchmi-icon-height":24},this.__$dom.Toolbar),null==this.__$controls.FreezeButton?this.__$log.warning("FreezeButton sub-control could not be created."):e.Binding.createEx2(`%ctrl%${this.getId()}::ImageFreeze%/ctrl%`,"StateSymbol",this.__$controls.FreezeButton)}__updateFreezeButtonIcon(){if(null==this.__$controls.FreezeButton)return;let t=e.Environment.getControlBasePathEx(this)||"";this.__$props.ImageFreeze?t+="/Images/pause.svg":t+="/Images/play.svg",this.__$controls.FreezeButton.setIcon(t)}__destroyFreezeButton(){null!=this.__$controls.FreezeButton&&(e.Binding.removeEx2(null,"StateSymbol",this.__$controls.FreezeButton),this.__$controls.FreezeButton.destroy(),this.__$controls.FreezeButton=null)}__createDownloadButton(){this.__$controls.DownloadButton=this.__$createSubControl("TcHmiButton","DownloadButton",{"data-tchmi-width":this.__$props.ToolbarHeight,"data-tchmi-height":this.__$props.ToolbarHeight,"data-tchmi-left":null,"data-tchmi-right":0,"data-tchmi-text":"","data-tchmi-icon":e.Environment.getControlBasePathEx(this)+"/Images/download.svg","data-tchmi-icon-width":24,"data-tchmi-icon-height":24},this.__$dom.Toolbar),null==this.__$controls.DownloadButton?this.__$log.warning("FreezeButton sub-control could not be created."):this.__destroyDownloadEventListener=e.EventProvider.register(this.__$controls.DownloadButton.getId()+".onPressed",(()=>{this.downloadImage()}))}__destroyDownloadButton(){null!=this.__$controls.DownloadButton&&(null!=this.__destroyDownloadEventListener&&(this.__destroyDownloadEventListener(),this.__destroyDownloadEventListener=null),this.__$controls.DownloadButton.destroy(),this.__$controls.DownloadButton=null)}__createScaleSelection(){const t=this.__$createSubControl("TcHmiCombobox","ScaleSelection",{"data-tchmi-width":80,"data-tchmi-height":this.__$props.ToolbarHeight,"data-tchmi-left":null,"data-tchmi-right":0,"data-tchmi-allow-text-input":!0},this.__$dom.Toolbar);if(this.__$controls.ScaleSelection=t,null!=t){let i;const s=e.Theme.Resources;i=s.get(this,"ScaleSelection_FontFamily"),i.error||t.setTextFontFamily(i.value),i=s.get(this,"ScaleSelection_FontSize"),i.error||t.setTextFontSize(i.value),i=s.get(this,"ScaleSelection_FontStyle"),i.error||t.setTextFontStyle(i.value),i=s.get(this,"ScaleSelection_FontWeight"),i.error||t.setTextFontWeight(i.value),i=s.get(this,"ScaleSelection_HorizontalAlignment"),i.error||t.setTextHorizontalAlignment(i.value),i=s.get(this,"ScaleSelection_ContentPadding"),i.error||t.setContentPadding(i.value),i=s.get(this,"ScaleSelection_MaxListHeight"),i.error||t.setMaxListHeight(i.value),i=s.get(this,"ScaleSelection_TextColor"),i.error||t.setTextColor(i.value),i=s.get(this,"ScaleSelection_DropDownBackgroundColor"),i.error||t.setDropDownBackgroundColor(i.value),i=s.get(this,"ScaleSelection_DropDownFontFamily"),i.error||t.setDropDownFontFamily(i.value),i=s.get(this,"ScaleSelection_DropDownFontSize"),i.error||t.setDropDownFontSize(i.value),i=s.get(this,"ScaleSelection_DropDownFontStyle"),i.error||t.setDropDownFontStyle(i.value),i=s.get(this,"ScaleSelection_DropDownFontWeight"),i.error||t.setDropDownFontWeight(i.value),i=s.get(this,"ScaleSelection_DropDownHorizontalAlignment"),i.error||t.setDropDownHorizontalAlignment(i.value),i=s.get(this,"ScaleSelection_DropDownTextColor"),i.error||t.setDropDownTextColor(i.value),i=s.get(this,"ScaleSelection_DropDownVerticalAlignment"),i.error||t.setDropDownVerticalAlignment(i.value),i=s.get(this,"ScaleSelection_DropDownStyle"),i.error||t.setDropDownStyle(i.value),i=s.get(this,"ScaleSelection_DataHeight"),i.error||t.setDataHeight(i.value),this.__destroyScalingSelectionEventListener=e.EventProvider.register(t.getId()+".onUserInteractionFinished",((e,t)=>{if(null==this.__$controls.ScaleSelection)return;const i=this.__$controls.ScaleSelection.getSelectedValue();if(-1===i)this.fitImageToControl(!0);else if(null==i){const e=this.__$controls.ScaleSelection.getText()||"";if("fit"===e.toLowerCase())this.fitImageToControl(!0);else{const t="string"==typeof e?parseInt(e):100;this.setScale(isNaN(t)?100:t)}}else this.setScale(i);window.setTimeout((()=>{$("html").click()}),200)})),this.__updateScaleSelectionOptions(),this.__updateScaleSelectionValue()}else this.__$log.warning("ScaleSelection sub-control could not be created.")}__updateScaleSelectionOptions(){if(!this.__isAttached||null==this.__$controls.ScaleSelection)return;const e=this.__$props.ScaleOptions.map(((e,t)=>({id:t+1,value:e,text:e+" %"}))),t=[{id:0,value:-1,text:"Fit"}].concat(e);this.__$controls.ScaleSelection.setSrcData(t)}__updateScaleSelectionValue(){null!=this.__$controls.ScaleSelection&&(this.__viewer.image.fitActive?this.__$controls.ScaleSelection.setText("Fit"):this.__$controls.ScaleSelection.setText(`${this.__$props.Scale.toFixed(0)} %`))}__destroyScaleSelection(){null!=this.__$controls.ScaleSelection&&(null!=this.__destroyScalingSelectionEventListener&&(this.__destroyScalingSelectionEventListener(),this.__destroyScalingSelectionEventListener=null),this.__$controls.ScaleSelection.destroy(),this.__$controls.ScaleSelection=null),this.__isAttached&&this.__$dom["ScaleSelection-TouchGuard"].css("display","none")}__createImageSelection(){const t=this.__$createSubControl("TcHmiCombobox","ImageSelection",{"data-tchmi-width":80,"data-tchmi-height":this.__$props.ToolbarHeight,"data-tchmi-left":null,"data-tchmi-right":0,"data-tchmi-content-padding":{top:3,right:3,bottom:3,left:3}},this.__$dom.Toolbar);if(this.__$controls.ImageSelection=t,null!=t){let i;const s=e.Theme.Resources;i=s.get(this,"ImageSelection_FontFamily"),i.error||t.setTextFontFamily(i.value),i=s.get(this,"ImageSelection_FontSize"),i.error||t.setTextFontSize(i.value),i=s.get(this,"ImageSelection_FontStyle"),i.error||t.setTextFontStyle(i.value),i=s.get(this,"ImageSelection_FontWeight"),i.error||t.setTextFontWeight(i.value),i=s.get(this,"ImageSelection_HorizontalAlignment"),i.error||t.setTextHorizontalAlignment(i.value),i=s.get(this,"ImageSelection_ContentPadding"),i.error||t.setContentPadding(i.value),i=s.get(this,"ImageSelection_MaxListHeight"),i.error||t.setMaxListHeight(i.value),i=s.get(this,"ImageSelection_TextColor"),i.error||t.setTextColor(i.value),i=s.get(this,"ImageSelection_DropDownBackgroundColor"),i.error||t.setDropDownBackgroundColor(i.value),i=s.get(this,"ImageSelection_DropDownFontFamily"),i.error||t.setDropDownFontFamily(i.value),i=s.get(this,"ImageSelection_DropDownFontSize"),i.error||t.setDropDownFontSize(i.value),i=s.get(this,"ImageSelection_DropDownFontStyle"),i.error||t.setDropDownFontStyle(i.value),i=s.get(this,"ImageSelection_DropDownFontWeight"),i.error||t.setDropDownFontWeight(i.value),i=s.get(this,"ImageSelection_DropDownHorizontalAlignment"),i.error||t.setDropDownHorizontalAlignment(i.value),i=s.get(this,"ImageSelection_DropDownTextColor"),i.error||t.setDropDownTextColor(i.value),i=s.get(this,"ImageSelection_DropDownVerticalAlignment"),i.error||t.setDropDownVerticalAlignment(i.value),i=s.get(this,"ImageSelection_DropDownStyle"),i.error||t.setDropDownStyle(i.value),i=s.get(this,"ImageSelection_DataHeight"),i.error||t.setDataHeight(i.value),e.Binding.createEx2(`%ctrl%${this.getId()}::ImageIndex|BindingMode=TwoWay%/ctrl%`,"SelectedIndex",t),this.__updateImageSelectionOptions()}else this.__$log.warning("ImageSelection sub-control could not be created.")}__updateImageSelectionOptions(){if(!this.__isAttached||null==this.__$controls.ImageSelection)return;const t=[];for(let i=0;i<this.__$props.ImageList.length;++i){let s=this.__$props.ImageList[i].name;if(!s){const t=new e.Symbol(this.__$props.ImageList[i].image);null!=t&&(s=t.getExpression().getName()||"")}t.push({id:i,value:i,text:s})}this.__$controls.ImageSelection.setSrcData(t)}__destroyImageSelection(){null!=this.__$controls.ImageSelection&&(e.Binding.removeEx2(null,"SelectedIndex",this.__$controls.ImageSelection),this.__$controls.ImageSelection.destroy(),this.__$controls.ImageSelection=null)}__updateOverlayElements(){this.__isAttached&&(this.__$dom.OverlaySVG.empty(),this.__$props.OverlayVisible&&this.__$props.OverlayElements.forEach((e=>{const s=e.size,o=s/2,a=e.color.color,r=e.thickness,_=t.CreateSVG("svg");_.attr("x","50%"),_.attr("y","50%"),_.css("overflow","visible");let n=!1;switch(e.shape){case i.Schema.OverlayElementShape.Circle:{const e=t.CreateSVG("circle").appendTo(_).attr("r",o);r>0?e.attr("fill","none").attr("stroke",a).attr("stroke-width",r):e.attr("fill",a),n=!0;break}case i.Schema.OverlayElementShape.Rectangle:{const e=t.CreateSVG("rect").appendTo(_).attr("x",-1*o).attr("y",-1*o).attr("width",s).attr("height",s);r>0?e.attr("fill","none").attr("stroke",a).attr("stroke-width",r):e.attr("fill",a),n=!0;break}case i.Schema.OverlayElementShape.Cross:{const e=t.CreateSVG("line").appendTo(_).attr("y1",0).attr("y2",0),i=t.CreateSVG("line").appendTo(_).attr("x1",0).attr("x2",0);s>0?(e.attr("x1",-1*o).attr("x2",o),i.attr("y1",-1*o).attr("y2",o)):(e.attr("x1","-50%").attr("x2","50%"),i.attr("y1","-50%").attr("y2","50%")),e.attr("stroke",a).attr("stroke-width",r),i.attr("stroke",a).attr("stroke-width",r),n=!0;break}case i.Schema.OverlayElementShape.Frame:{const e=o*.7;[[[-o,-e],[-o,-o],[-e,-o]],[[e,-o],[o,-o],[o,-e]],[[o,e],[o,o],[e,o]],[[-e,o],[-o,o],[-o,e]]].forEach((e=>{const i=e.map((e=>e.join(","))).join(" ");t.CreateSVG("polyline").appendTo(_).attr("points",i).attr("fill","none").attr("stroke",a).attr("stroke-width",r)})),n=!0;break}default:console.warn("other aid element shapes are not implemented yet.")}n&&_.appendTo(this.__$dom.OverlaySVG)})))}__updatePixelColorInfo(){if(this.__isAttached&&null!=this.__$props.PixelColorFormat)try{const t=new e.Function(this.__$props.PixelColorFormat).execute([this.__$props.PixelColor]);this.__$dom["Infobar-PixelColor"].html(t)}catch(e){this.__$log.warning("Could not execute InfobarShapeFormat function.",e)}}__updatePixelPositionInfo(){if(!this.__isAttached)return;const e=this.__$props.PixelPosition;this.__$dom["Infobar-PixelPosition"].html(e[0]+", "+e[1])}__updateDataRate(e){var t;for(this.__diagnostics.dataReceivalList.push({DataAmount:e,Timestamp:(new Date).getTime()});this.__diagnostics.dataReceivalList.length>this.__$props.AveragingInterval+1;)this.__diagnostics.dataReceivalList.shift();if(1===this.__diagnostics.dataReceivalList.length)return void this.__setDataRateInternal(0);const i=(null===(t=this.__diagnostics.dataReceivalList.shift())||void 0===t?void 0:t.Timestamp)||0,s=this.__diagnostics.dataReceivalList.reduce(((e,t)=>e+t.DataAmount),0),o=(this.__diagnostics.dataReceivalList[this.__diagnostics.dataReceivalList.length-1].Timestamp-i)/1e3,a=Math.round(s/o*100)/100;this.__setDataRateInternal(a)}__updateImageRate(){for(this.__diagnostics.imageReceivalList.push((new Date).getTime());this.__diagnostics.imageReceivalList.length>this.__$props.AveragingInterval+1;)this.__diagnostics.imageReceivalList.shift();if(1===this.__diagnostics.imageReceivalList.length)return void this.__setImageRateInternal(0);const e=(this.__diagnostics.imageReceivalList[this.__diagnostics.imageReceivalList.length-1]-this.__diagnostics.imageReceivalList[0])/1e3,t=this.__diagnostics.imageReceivalList.length-1,i=Math.round(t/e*100)/100;this.__setImageRateInternal(i)}__downloadImage(i){if(this.__viewer.image.dataUri){if(!i){i="";let s="png";const o=e.Binding.resolveEx("Image",this);if(null!=o){const t=o.getName();if(null!=t){if(" (QI).Stream"===t.substring(t.length-12))return void e.Functions.Beckhoff.Log("Warning","Cannot download image if bound as stream.");const o=t.split(" (QI).");if(o.length>1){const e=o[o.length-1].toLowerCase();["bmp","jpeg","png"].includes(e)&&(s=e)}const a=t.indexOf(" ");i+=a<0?t:t.substring(0,a)}}0===i.length&&(i+=this.__id);const a=new Date;i+=`_${`${a.getUTCFullYear()}${t.leadingZeros(a.getUTCMonth()+1)}${t.leadingZeros(a.getUTCDate())}`}_${`${t.leadingZeros(a.getUTCHours())}${t.leadingZeros(a.getUTCMinutes())}${t.leadingZeros(a.getUTCSeconds())}-${t.leadingZeros(a.getUTCMilliseconds(),3)}`}.${s}`}this.__triggerImageDownload(this.__viewer.image.dataUri,i)}}__triggerImageDownload(e,t){const i=document.createElement("a");document.body.appendChild(i),i.setAttribute("href",e),i.setAttribute("download",t),i.click(),i.remove()}__registerDomElements(){this.__$dom.registerEx(["Viewer","Image","Surface","Placeholder","Toolbar","Infobar","Frame","Infobar-ShapeValueIcon","Infobar-ShapeValue","Infobar-PixelPositionIcon","Infobar-PixelPosition","Infobar-PixelColorIcon","Infobar-PixelColor","Infobar-ImageSizeIcon","Infobar-ImageSize","Thumbnail","ThumbnailMarker","OverlayImage","OverlaySVG","ScaleSelection-TouchGuard"],".TcHmi_Controls_Beckhoff_Vision_TcHmiVnImage-");const t=e.Environment.getControlBasePathEx(this);this.__$dom.Image.bind("load",(e=>{this.__diagnostics.sourceWasSetEvent.Last<this.__diagnostics.sourceWasSetEvent.Id-1&&(++this.__diagnostics.imagesLost,++this.__diagnostics.sourceWasSetEvent.Last);const t=(new Date).getTime()-this.__diagnostics.sourceWasSetEvent.Time;this.__setImageRenderTimeInternal(t)})),this.__$dom["Infobar-ShapeValueIcon"].attr("src",t+"/Images/shapes.svg"),this.__$dom["Infobar-PixelColorIcon"].attr("src",t+"/Images/color_palette.svg"),this.__$dom["Infobar-PixelPositionIcon"].attr("src",t+"/Images/ruler_pos.svg"),this.__$dom["Infobar-ImageSizeIcon"].attr("src",t+"/Images/image_size.svg"),this.__$dom["ScaleSelection-TouchGuard"].bind("click",(e=>{null!=this.__$controls.ScaleSelection&&(this.__$controls.ScaleSelection.__setDropDownboxOpen(),e.stopPropagation())}))}__fitImageToControl(e=!1){let t;if(1*this.__$props.ImageSize[0]/this.__$props.ImageSize[1]>=1*this.__viewer.frame.width/this.__viewer.frame.height){t=this.__viewer.frame.width/(this.__$props.ImageSize[0]||1)*100}else{t=this.__viewer.frame.height/(this.__$props.ImageSize[1]||1)*100}this.__viewer.image.autoScaling?this.__setScaleInternal(t/this.__viewer.image.scaleFactor):this.__setScaleInternal(t),e?window.setTimeout((()=>{this.__centerImageToControl(),this.__viewer.image.fitActive=!0,this.__viewer.image.fitDone=!0,null!=this.__$controls.ScaleSelection&&this.__$controls.ScaleSelection.setText("Fit")}),0):this.__setOffsetInternal([0,0]),this.__viewer.image.fitActive=!0,this.__viewer.image.fitDone=!0,null!=this.__$controls.ScaleSelection&&this.__$controls.ScaleSelection.setText("Fit"),this.__updateImageUI()}__cancelFitImageToControl(){this.__viewer.image.fitActive&&(this.__viewer.image.fitActive=!1,this.__updateScaleSelectionValue())}__centerImageToControl(){const e=t.Vector.fromArray([this.__viewer.frame.width,this.__viewer.frame.height]).times(.5),i=t.Vector.fromArray([this.__$props.Offset[0]+this.__viewer.image.screenSize[0]/2,this.__$props.Offset[1]+this.__viewer.image.screenSize[1]/2]),s=t.Vector.fromArray(this.__$props.Offset),o=e.minus(i),a=s.plus(o);this.__setOffsetInternal(a.toArray())}__constrainOffset(e,t){const i=[e[0],e[1]],s=10,o=e[0],a=e[1],r=this.__$props.ImageSize[0]*t*this.__viewer.image.scaleFactor/100,_=this.__$props.ImageSize[1]*t*this.__viewer.image.scaleFactor/100,n=a+_;return o+r<-10?i[0]=-10-r:o>this.__viewer.frame.width+s&&(i[0]=this.__viewer.frame.width+s),n<-10?i[1]=-10-_:a>this.__viewer.frame.height+s&&(i[1]=this.__viewer.frame.height+s),i}__activateShape(){this.__deactivateShape();const i={"data-tchmi-width":3*this.__viewer.image.screenSize[0],"data-tchmi-height":3*this.__viewer.image.screenSize[1],"data-tchmi-left":this.__$props.Offset[0]-this.__viewer.image.screenSize[0],"data-tchmi-top":this.__$props.Offset[1]-this.__viewer.image.screenSize[1],"data-tchmi-stroke-thickness":this.__$props.ShapeStrokeThickness,"data-tchmi-stroke-color":this.__$props.ShapeStrokeColor,"data-tchmi-handle-size":this.__$props.ShapeHandleSize,"data-tchmi-handle-color":this.__$props.ShapeHandleColor,"data-tchmi-data-offset":this.__viewer.image.screenSize,"data-tchmi-data-scale":this.__$props.Scale/100*this.__viewer.image.scaleFactor,"data-tchmi-clickable-size":this.__$props.ShapeClickableSize};let s="TcHmi.Controls.Beckhoff.Vision.";switch(this.__$props.ShapeType){case t.ShapeType.Point:i["data-tchmi-num-points"]=1,i["data-tchmi-closed"]=!1,i["data-tchmi-rotation-handle"]=!1,s+="TcHmiVnPolygon";break;case t.ShapeType.Line:i["data-tchmi-num-points"]=2,i["data-tchmi-closed"]=!1,i["data-tchmi-rotation-handle"]=!1,s+="TcHmiVnPolygon";break;case t.ShapeType.Square:i["data-tchmi-stroke-shape"]="Rectangle",i["data-tchmi-aspect-ratio"]=1,i["data-tchmi-rotation-handle"]=this.__$props.ShapeIsRotatable,i["data-tchmi-edge-handles"]=!1,s+="TcHmiVnRectangle";break;case t.ShapeType.Rectangle:i["data-tchmi-stroke-shape"]="Rectangle",i["data-tchmi-rotation-handle"]=this.__$props.ShapeIsRotatable,s+="TcHmiVnRectangle";break;case t.ShapeType.Circle:i["data-tchmi-stroke-shape"]="Ellipse",i["data-tchmi-aspect-ratio"]=1,i["data-tchmi-rotation-handle"]=!1,i["data-tchmi-edge-handles"]=!1,s+="TcHmiVnRectangle";break;case t.ShapeType.Ellipse:i["data-tchmi-stroke-shape"]="Ellipse",i["data-tchmi-rotation-handle"]=this.__$props.ShapeIsRotatable,s+="TcHmiVnRectangle";break;case t.ShapeType.Polygon:i["data-tchmi-max-points"]=0,i["data-tchmi-closed"]=!0,i["data-tchmi-rotation-handle"]=this.__$props.ShapeIsRotatable,s+="TcHmiVnPolygon"}this.__$controls.Shape=this.__$createSubControl(s,"Shape",i,this.__$dom.Surface),null!=this.__$controls.Shape&&(e.Binding.createEx2(`%ctrl%${this.__id}::ShapeData%/ctrl%`,"ShapeData",this.__$controls.Shape),e.Binding.createEx2(`%ctrl%${this.__id}::ShapeAngleInterval%/ctrl%`,"AngleInterval",this.__$controls.Shape),this.__destroyShapeEventListener=e.EventProvider.register(this.__$controls.Shape.getId()+".onShapeConfirmed",this.__updateShapeInfo.bind(this,this.__$props.ShapeType)))}__deactivateShape(){null!=this.__$controls.Shape&&(e.Binding.removeEx2(`%ctrl%${this.__id}::ShapeData%/ctrl%`,"ShapeData",this.__$controls.Shape),e.Binding.removeEx2(`%ctrl%${this.__id}::ShapeAngleInterval%/ctrl%`,"AngleInterval",this.__$controls.Shape),this.__$controls.Shape.destroy(),this.__$controls.Shape=null,null!=this.__destroyShapeEventListener&&(this.__destroyShapeEventListener(),this.__destroyShapeEventListener=null),this.__$props.ShapeAutoClear&&this.__clearShape())}__clearShape(){if(!this.__isAttached)return this.__clearShapeProperties(),void this.__updateShapeIsInImageArea();null!=this.__$controls.Shape&&this.__$controls.Shape.clear(),this.__clearShapeProperties(),this.__updateShapeIsInImageArea(),this.__$dom["Infobar-ShapeValue"].html("")}__clearShapeProperties(){const e=t.GetEmptyCoordinatesForShapeType(this.__$props.ShapeType);this.setShapeData(e)}__setView(e){if(e[2]/e[3]>=this.__viewer.frame.width/this.__viewer.frame.height){const i=this.__viewer.frame.width/e[2]/this.__viewer.image.scaleFactor*100;let s=t.Vector.fromArray(e.slice(0,2)).times(-i*this.__viewer.image.scaleFactor/100);s.y+=(this.__viewer.frame.height-e[3]*i*this.__viewer.image.scaleFactor/100)/2,this.__setScaleInternal(i),this.__setOffsetInternal(s.toArray())}else{const i=this.__viewer.frame.height/e[3]/this.__viewer.image.scaleFactor*100;let s=t.Vector.fromArray(e.slice(0,2)).times(-i*this.__viewer.image.scaleFactor/100);s.x+=(this.__viewer.frame.width-e[2]*i*this.__viewer.image.scaleFactor/100)/2,this.__setScaleInternal(i),this.__setOffsetInternal(s.toArray())}}__updateShapeIsInImageArea(){this.__setShapeIsInImageAreaInternal(this.__shapeIsInImageArea())}__shapeIsInImageArea(){if(null==this.__$controls.Shape)return!1;const e=this.__$props.ImageSize[0],i=this.__$props.ImageSize[1];let s=[];switch(this.__$props.ShapeType){case t.ShapeType.Point:case t.ShapeType.Line:case t.ShapeType.Polygon:if(!Array.isArray(this.__$props.ShapeData))return!1;s=this.__$props.ShapeData;break;case t.ShapeType.Square:case t.ShapeType.Rectangle:case t.ShapeType.Circle:case t.ShapeType.Polygon:const e=this.__$props.ShapeData,i=e.stSize.fWidth,o=e.stSize.fHeight,a=e.fAngle/360*2*Math.PI,r=Math.atan2(o,i),_=Math.sqrt(Math.pow(i,2)+Math.pow(o,2)),n=e.aCenter;s.push(new t.Vector(_/2,0).rotate2d(a+r).plus(n)),s.push(new t.Vector(-_/2,0).rotate2d(a-r).plus(n)),s.push(new t.Vector(-_/2,0).rotate2d(a+r).plus(n)),s.push(new t.Vector(_/2,0).rotate2d(a-r).plus(n));break;default:return!1}for(const t of s)if(t[0]<0||t[0]>e||t[1]<0||t[1]>i)return!1;return!0}getBarColor(){return this.__$props.BarColor}setBarColor(e){"None"===e.color&&(e.color="transparent"),this.__$setProperty("BarColor",e)}__processBarColor(){this.__updateToolbar(),this.__updateInfobar()}getShapeStrokeColor(){return this.__$props.ShapeStrokeColor}setShapeStrokeColor(e){this.__$setProperty("ShapeStrokeColor",e)}__processShapeStrokeColor(e){null!=this.__$controls.Shape&&this.__$controls.Shape.setStrokeColor(e)}getShapeHandleColor(){return this.__$props.ShapeHandleColor}setShapeHandleColor(e){this.__$setProperty("ShapeHandleColor",e)}__processShapeHandleColor(e){null!=this.__$controls.Shape&&this.__$controls.Shape.setHandleColor(e)}__processWidth(){super.__processWidth(),this.__isAttached&&this.__updateAppearance()}__processHeight(){super.__processHeight(),this.__isAttached&&this.__updateAppearance()}getImage(){return this.__$props.Image}setImage(e){this.__$setProperty("Image",e)}__processImage(e){if(0===this.__$props.QueueIndex||this.__$props.QueueIndex>this.__viewer.image.historyQueue.length-1)for(this.__viewer.image.historyQueue.unshift(e||"");this.__viewer.image.historyQueue.length>this.__$props.QueueSize+1;)this.__viewer.image.historyQueue.pop();const t="string"==typeof e?2*e.length:0;this.__setDataReceivedInternal(this.__$props.DataReceived+t),this.__updateDataRate(t),this.__setImagesReceivedInternal(this.__$props.ImagesReceived+1),this.__updateImageRate(),this.__$events.ImageReceived.raise(),this.__$props.ImageFreeze||this.__updateViewer()}__updateImageBinding(){if(e.Binding.removeEx2(null,"Image",this),null==this.__$props.ImageList[this.__$props.ImageIndex])return;const t=this.__$props.ImageList[this.__$props.ImageIndex].image;e.Binding.createEx2(t,"Image",this)}getImageList(){return this.__$props.ImageList}setImageList(e){this.__$setProperty("ImageList",e)}__processImageList(){this.__updateImageBinding(),this.__$props.ToolbarItems.imageSelectionVisible&&this.__updateToolbar()}getImageIndex(){return this.__$props.ImageIndex}setImageIndex(e){this.__$setProperty("ImageIndex",e)}__processImageIndex(e){this.__updateImageBinding()}getAlt(){return this.__$props.Alt}setAlt(e){this.__$setProperty("Alt",e)}__processAlt(){this.__isAttached&&(this.__$dom.Placeholder.children().html(this.__$props.Alt),this.__$dom.Image.attr("alt",this.__$props.Alt))}downloadImage(t){e.Access.checkAccess(this,"operate")&&this.__downloadImage(t)}getImageFreeze(){return this.__$props.ImageFreeze}setImageFreeze(e){this.__$setProperty("ImageFreeze",e)}__setImageFreezeInternal(e){this.__$setPropertyInternal("ImageFreeze",e)}__processImageFreeze(e){this.__updateFreezeButtonIcon(),e||this.__updateViewer()}getOffset(){return this.__$props.Offset}setOffset(e){const i=t.Helpers.ValueConverter.toArray2(e);null===i?this.__$log.error('Invalid value for property "Offset"'):this.__$setProperty("Offset",i)}__setOffsetInternal(e){const i=t.Helpers.ValueConverter.toArray2(e);null===i?this.__$log.error('Invalid value for property "Offset"'):this.__$setPropertyInternal("Offset",i)}__processOffset(){this.__cancelFitImageToControl(),this.__updateViewer()}getScale(){return this.__$props.Scale}setScale(e){this.__$setProperty("Scale",e)}__setScaleInternal(e){this.__$setPropertyInternal("Scale",e)}__processScale(e,s,o){if(this.__cancelFitImageToControl(),!o)switch(this.__$props.ScalingCenter){case i.Schema.ScalingCenter.TopLeftCorner:break;case i.Schema.ScalingCenter.ImageCenter:{const i=e-s;if(0===i)return;if(s<this.__$props.ScaleMin||s>this.__$props.ScaleMax)return;const o=t.Vector.fromArray(this.__$props.ImageSize).times(this.__viewer.image.scaleFactor).times(i/2/100),a=t.Vector.fromArray(this.__$props.Offset).minus(o);this.__setOffsetInternal(a.toArray());break}case i.Schema.ScalingCenter.ControlCenter:{const i=e-s;if(0===i)return;if(s<this.__$props.ScaleMin||s>this.__$props.ScaleMax)return;const o=new t.Vector(this.__viewer.frame.width,this.__viewer.frame.height).times(.5),a=t.Vector.fromArray(this.__$props.Offset).minus(o).times(1+i/s),r=o.plus(a);this.__setOffsetInternal(r.toArray());break}}this.__updateScaleSelectionValue(),this.__updateViewer()}getScaleUnit(){return"%"}setScaleUnit(e){}getScaleReference(){return this.__$props.ScaleReference}setScaleReference(e){this.__$setProperty("ScaleReference",e)}__processScaleReference(e){this.__viewer.image.autoScaling=e!==i.Schema.ScaleReference.ImageSize}getDraggable(){return this.__$props.Draggable}setDraggable(e){this.__$setProperty("Draggable",e)}getScalable(){return this.__$props.Scalable}setScalable(e){this.__$setProperty("Scalable",e)}getScaleMin(){return this.__$props.ScaleMin}setScaleMin(e){this.__$setProperty("ScaleMin",e)}getScaleMax(){return this.__$props.ScaleMax}setScaleMax(e){this.__$setProperty("ScaleMax",e)}getScalingCenter(){return this.__$props.ScalingCenter}setScalingCenter(e){this.__$setProperty("ScalingCenter",e)}getView(){return this.__$props.View}setView(e){this.__setView(e)}fitImageToControl(e=!1){this.__fitImageToControl(e)}centerImageToControl(){this.__centerImageToControl()}getToolbarVisible(){return this.__$props.ToolbarVisible}setToolbarVisible(e){this.__$setProperty("ToolbarVisible",e)}__processToolbarVisible(e){this.__updateLayout()}getToolbarItems(){return this.__$props.ToolbarItems}setToolbarItems(e){this.__$setProperty("ToolbarItems",e)}__processToolbarItems(e){this.__updateToolbar()}getScaleOptions(){return this.__$props.ScaleOptions}setScaleOptions(e){this.__$setProperty("ScaleOptions",e)}__processScaleOptions(){this.__updateScaleSelectionOptions()}getToolbarHeight(){return this.__$props.ToolbarHeight}setToolbarHeight(e){this.__$setProperty("ToolbarHeight",Math.min(e,150))}__processToolbarHeight(){this.__updateLayout()}getToolbarHeightUnit(){return"px"}setToolbarHeightUnit(e){}getImageSelectionWidth(){return this.__$props.ImageSelectionWidth}setImageSelectionWidth(e){this.__$setProperty("ImageSelectionWidth",e)}__processImageSelectionWidth(){this.__updateToolbar()}getImageSelectionWidthUnit(){return"px"}setImageSelectionWidthUnit(e){}getScaleSelectionWidth(){return this.__$props.ScaleSelectionWidth}setScaleSelectionWidth(e){this.__$setProperty("ScaleSelectionWidth",e)}__processScaleSelectionWidth(){this.__updateToolbar()}getScaleSelectionWidthUnit(){return"px"}setScaleSelectionWidthUnit(e){}getScaleSelectionEditable(){return this.__$props.ScaleSelectionEditable}setScaleSelectionEditable(e){this.__$setProperty("ScaleSelectionEditable",e)}__processScaleSelectionEditable(e){null!=this.__$controls.ScaleSelection&&(this.__$controls.ScaleSelection.setAllowTextInput(e),e?this.__$dom["ScaleSelection-TouchGuard"].css("display","none"):this.__$dom["ScaleSelection-TouchGuard"].css("display","block"))}getInfobarVisible(){return this.__$props.InfobarVisible}setInfobarVisible(e){this.__$setProperty("InfobarVisible",e)}__processInfobarVisible(){this.__updateLayout()}getInfobarItems(){return this.__$props.InfobarItems}setInfobarItems(e){this.__$setProperty("InfobarItems",e)}__processInfobarItems(){this.__updateInfobar()}getPixelColorFormat(){return this.__$props.PixelColorFormat}setPixelColorFormat(e){this.__$setProperty("PixelColorFormat",e)}getInfobarHeight(){return this.__$props.InfobarHeight}setInfobarHeight(e){this.__$setProperty("InfobarHeight",Math.min(e,150))}__processInfobarHeight(){this.__updateLayout()}getInfobarHeightUnit(){return"px"}setInfobarHeightUnit(e){}getShapeValueFormat(){return this.__$props.ShapeValueFormat}setShapeValueFormat(e){this.__$setProperty("ShapeValueFormat",e)}__processInfobarShapeFormat(){this.__updateLayout()}getShapeSelectionActive(){return this.__$props.ShapeSelectionActive}setShapeSelectionActive(e){this.__$setProperty("ShapeSelectionActive",e)}__setShapeSelectionActiveInternal(e){this.__$setPropertyInternal("ShapeSelectionActive",e)}__processShapeSelectionActive(e,t){!0===e&&!1===t?this.__activateShape():!1===e&&!0===t&&this.__deactivateShape(),this.__updateShapeButtonIcon()}getShapeType(){return this.__$props.ShapeType}setShapeType(e){this.__$setProperty("ShapeType",e)}__processShapeType(e,t){e!==t&&null!=this.__$controls.Shape&&(this.__deactivateShape(),this.__activateShape())}getShapeIsRotatable(){return this.__$props.ShapeIsRotatable}setShapeIsRotatable(e){this.__$setProperty("ShapeIsRotatable",e)}__processShapeIsRotatable(e,t){e!==t&&null!=this.__$controls.Shape&&(this.__deactivateShape(),this.__activateShape())}getShapeData(){return this.__$props.ShapeData}setShapeData(e){this.__$setProperty("ShapeData",e)}getShapeAutoClear(){return this.__$props.ShapeAutoClear}setShapeAutoClear(e){this.__$setProperty("ShapeAutoClear",e)}clearShape(){this.__clearShape()}getShapeStrokeThickness(){return this.__$props.ShapeStrokeThickness}setShapeStrokeThickness(e){this.__$setProperty("ShapeStrokeThickness",e)}__processShapeStrokeThickness(e){null!=this.__$controls.Shape&&this.__$controls.Shape.setStrokeThickness(e)}getShapeStrokeThicknessUnit(){return"px"}setShapeStrokeThicknessUnit(e){}getShapeHandleSize(){return this.__$props.ShapeHandleSize}setShapeHandleSize(e){this.__$setProperty("ShapeHandleSize",e)}__processShapeHandleSize(e){null!=this.__$controls.Shape&&this.__$controls.Shape.setHandleSize(e)}getShapeHandleSizeUnit(){return"px"}setShapeHandleSizeUnit(e){}getShapeClickableSize(){return this.__$props.ShapeClickableSize}setShapeClickableSize(e){this.__$setProperty("ShapeClickableSize",e)}__processShapeClickableSize(e){null!=this.__$controls.Shape&&this.__$controls.Shape.setClickableSize(e)}getShapeClickableSizeUnit(){return"px"}setShapeClickableSizeUnit(e){}getShapeAngleInterval(){return this.__$props.ShapeAngleInterval}setShapeAngleInterval(e){this.__$setProperty("ShapeAngleInterval",e)}getShapeIsInImageArea(){return this.__$props.ShapeIsInImageArea}setShapeIsInImageArea(e){this.__$setProperty("ShapeIsInImageArea",e)}__setShapeIsInImageAreaInternal(e){this.__$setPropertyInternal("ShapeIsInImageArea",e)}getThumbnailVisible(){return this.__$props.ThumbnailVisible}setThumbnailVisible(e){this.__$setProperty("ThumbnailVisible",e)}__processThumbnailVisible(){this.__updateThumbnail(),this.__updateThumbnailPosition()}getThumbnailPosition(){return this.__$props.ThumbnailPosition}setThumbnailPosition(e){this.__$setProperty("ThumbnailPosition",e)}__processThumbnailPosition(e){this.__updateThumbnailPosition()}getThumbnailSize(){return this.__$props.ThumbnailSize}setThumbnailSize(e){this.__$setProperty("ThumbnailSize",e)}__processThumbnailSize(){this.__updateThumbnail()}getThumbnailSizeUnit(){return"px"}setThumbnailSizeUnit(e){}getOverlayVisible(){return this.__$props.OverlayVisible}setOverlayVisible(e){this.__$setProperty("OverlayVisible",e)}__processOverlayVisible(){this.__updateViewer(),this.__updateOverlayElements()}getOverlayImage(){return this.__$props.OverlayImage}setOverlayImage(e){this.__$setProperty("OverlayImage",e)}__processOverlayImage(){this.__updateViewer()}getOverlayElements(){return this.__$props.OverlayElements}setOverlayElements(e){this.__$setProperty("OverlayElements",e)}__processOverlayElements(){this.__updateOverlayElements()}getPixelInfoUpdate(){return this.__$props.PixelInfoUpdate}setPixelInfoUpdate(e){this.__$setProperty("PixelInfoUpdate",e)}__setPixelInfoUpdateInternal(e){this.__$setPropertyInternal("PixelInfoTrigger",e)}getImageSize(){return this.__$props.ImageSize}__setImageSizeInternal(e){this.__$setPropertyInternal("ImageSize",e)}__processImageSize(e){this.__isAttached&&(this.__$dom["Infobar-ImageSize"].html(e[0]+" × "+e[1]),this.__updateOverlayElements())}getImageDisplaySize(){return this.__$props.ImageDisplaySize}__setImageDisplaySizeInternal(e){this.__$setPropertyInternal("ImageDisplaySize",e)}getPixelPosition(){return this.__$props.PixelPosition}__setPixelPositionInternal(e){this.__$setPropertyInternal("PixelPosition",e)}__processPixelPosition(){this.__updatePixelPositionInfo()}getPixelColor(){return this.__$props.PixelColor}__setPixelColorInternal(e){this.__$setPropertyInternal("PixelColor",e)}__processPixelColor(){this.__updatePixelColorInfo()}getQueueIndex(){return this.__$props.QueueIndex}setQueueIndex(e){this.__$setProperty("QueueIndex",e)}__setQueueIndexInternal(e){this.__$setPropertyInternal("QueueIndex",e)}__processQueueIndex(e){this.__updateViewer()}getQueueSize(){return this.__$props.QueueSize}setQueueSize(e){this.__$setProperty("QueueSize",e)}__setQueueSizeInternal(e){this.__$setPropertyInternal("QueueSize",e)}__processQueueSize(e){for(;this.__viewer.image.historyQueue.length>e+1;)this.__viewer.image.historyQueue.pop();this.__updateViewer()}GetDiagnostics(){return{AveragingInterval:this.__$props.AveragingInterval,ImageRate:this.__$props.ImageRate,ImagesReceived:this.__$props.ImagesReceived,DataRate:this.__$props.DataRate,DataReceived:this.__$props.DataReceived,ImageRenderTime:this.__$props.ImageRenderTime}}getAveragingInterval(){return this.__$props.AveragingInterval}setAveragingInterval(e){this.__$setProperty("AveragingInterval",e)}getImageRate(){return this.__$props.ImageRate}__setImageRateInternal(e){this.__$setPropertyInternal("ImageRate",e)}getImagesReceived(){return this.__$props.ImagesReceived}__setImagesReceivedInternal(e){this.__$setPropertyInternal("ImagesReceived",e)}resetImagesReceived(){this.__setImagesReceivedInternal(0)}getDataRate(){return this.__$props.DataRate}__setDataRateInternal(e){this.__$setPropertyInternal("DataRate",e)}getDataReceived(){return this.__$props.DataReceived}__setDataReceivedInternal(e){this.__$setPropertyInternal("DataReceived",e)}resetDataReceived(){this.__setDataReceivedInternal(0)}getImageRenderTime(){return this.__$props.ImageRenderTime}__setImageRenderTimeInternal(e){this.__$setPropertyInternal("ImageRenderTime",e)}get SubControls(){return{ImageSelection:this.__$controls.ImageSelection,ScaleSelection:this.__$controls.ScaleSelection,DownloadButton:this.__$controls.DownloadButton,FreezeButton:this.__$controls.FreezeButton,ShapeButton:this.__$controls.ShapeButton}}}t.TcHmiVnImage=i,function(e){class i extends t.TcHmiVnControl.Properties{constructor(){super(...arguments),this.BarColor={color:"rgba(255, 255, 255, 0.5)"},this.ShapeStrokeColor={color:"#FF000000"},this.ShapeHandleColor={color:"#FF000000"},this.Image=null,this.ImageList=[],this.ImageIndex=0,this.Alt="No image available.",this.ImageFreeze=!1,this.Offset=[0,0],this.Scale=100,this.ScaleReference=o.ScaleReference.ImageSize,this.Draggable=!0,this.Scalable=!0,this.ScaleMin=10,this.ScaleMax=250,this.ScalingCenter=o.ScalingCenter.TopLeftCorner,this.View=[0,0,0,0],this.ToolbarVisible=!0,this.ToolbarItems={imageSelectionVisible:!0,scaleSelectionVisible:!0,shapeButtonVisible:!0,freezeButtonVisible:!0},this.ScaleOptions=[50,75,100,150,200],this.ToolbarHeight=24,this.ImageSelectionWidth=80,this.ScaleSelectionWidth=80,this.ScaleSelectionEditable=!1,this.InfobarVisible=!0,this.InfobarItems={shapeValueVisible:!0,pixelColorVisible:!0,pixelPositionVisible:!0,imageSizeVisible:!0},this.PixelColorFormat=null,this.InfobarHeight=24,this.ShapeValueFormat=null,this.ShapeSelectionActive=!1,this.ShapeType=t.ShapeType.Rectangle,this.ShapeIsRotatable=!0,this.ShapeData=null,this.ShapeAutoClear=!0,this.ShapeStrokeThickness=3,this.ShapeHandleSize=5,this.ShapeClickableSize=5,this.ShapeAngleInterval=0,this.ShapeIsInImageArea=!1,this.ThumbnailVisible=!1,this.ThumbnailPosition=o.ThumbnailPosition.BottomRight,this.ThumbnailSize=40,this.OverlayVisible=!1,this.OverlayImage=null,this.OverlayElements=[],this.ImageSize=[0,0],this.ImageDisplaySize=[0,0],this.PixelPosition=[0,0],this.PixelColor=[0,0,0,0],this.PixelInfoUpdate=e.Schema.PixelInfoUpdate.AtClick,this.QueueIndex=0,this.QueueSize=0,this.AveragingInterval=1,this.ImageRate=0,this.ImagesReceived=0,this.DataRate=0,this.DataReceived=0,this.ImageRenderTime=0}}e.Properties=i;class s extends t.TcHmiVnControl.SubControls{}let o;e.SubControls=s,function(e){let t,i,s,o,a;!function(e){e.ImageSize="ImageSize",e.ControlWidth="ControlWidth",e.ControlHeight="ControlHeight",e.ControlSize="ControlSize"}(t=e.ScaleReference||(e.ScaleReference={})),function(e){e.TopLeftCorner="TopLeftCorner",e.ImageCenter="ImageCenter",e.ControlCenter="ControlCenter"}(i=e.ScalingCenter||(e.ScalingCenter={})),function(e){e.TopLeft="TopLeft",e.TopRight="TopRight",e.BottomLeft="BottomLeft",e.BottomRight="BottomRight"}(s=e.ThumbnailPosition||(e.ThumbnailPosition={})),function(e){e.Circle="Circle",e.Cross="Cross",e.Rectangle="Rectangle",e.Frame="Frame"}(o=e.OverlayElementShape||(e.OverlayElementShape={})),function(e){e.None="Never",e.AtClick="AtClick",e.AtCursor="AtCursor"}(a=e.PixelInfoUpdate||(e.PixelInfoUpdate={}))}(o=e.Schema||(e.Schema={}))}(i=t.TcHmiVnImage||(t.TcHmiVnImage={}))}(i=t.Vision||(t.Vision={}))}(i=t.Beckhoff||(t.Beckhoff={})),t.registerEx("TcHmiVnImage","TcHmi.Controls.Beckhoff.Vision",i.Vision.TcHmiVnImage)}(t=e.Controls||(e.Controls={}))}(TcHmi||(TcHmi={}));